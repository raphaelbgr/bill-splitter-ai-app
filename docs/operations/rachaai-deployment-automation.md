# RachaAI - Deployment Automation Scripts
## Brazilian Hosting & LGPD Compliance

*Generated by Sally - UX Expert & DevOps Specialist*
*Created: December 2024*

---

## Deployment Overview

This document contains comprehensive deployment automation scripts for RachaAI, designed for Brazilian hosting with LGPD compliance, regional performance optimization, and cost management.

---

## 1. Vercel Deployment Configuration

### 1.1 Main Deployment Script

**File:** `scripts/deploy-brazilian.sh`

```bash
#!/bin/bash

# RachaAI Brazilian Deployment Script
# Optimized for Vercel + Supabase + Redis Cloud

set -e

echo "üöÄ Starting RachaAI Brazilian deployment..."

# Environment validation
if [ -z "$VERCEL_TOKEN" ]; then
    echo "‚ùå VERCEL_TOKEN not set"
    exit 1
fi

if [ -z "$SUPABASE_URL" ]; then
    echo "‚ùå SUPABASE_URL not set"
    exit 1
fi

# Build optimization for Brazilian networks
echo "üì¶ Building optimized bundle for Brazilian users..."

# Set Brazilian-specific build flags
export NEXT_PUBLIC_BRAZILIAN_REGION="true"
export NEXT_PUBLIC_LGPD_COMPLIANCE="true"
export NEXT_PUBLIC_CLAUDE_COST_OPTIMIZATION="true"

# Build with Brazilian optimizations
npm run build:brazilian

# Deploy to Vercel with Brazilian edge locations
echo "üåç Deploying to Brazilian edge locations..."

vercel --prod \
    --token $VERCEL_TOKEN \
    --confirm \
    --env NEXT_PUBLIC_SUPABASE_URL=$SUPABASE_URL \
    --env NEXT_PUBLIC_SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY \
    --env REDIS_URL=$REDIS_URL \
    --env CLAUDE_API_KEY=$CLAUDE_API_KEY \
    --env BRAZILIAN_REGION="true" \
    --env LGPD_COMPLIANCE="true"

echo "‚úÖ Deployment completed successfully!"
```

### 1.2 Vercel Configuration

**File:** `vercel.json`

```json
{
  "version": 2,
  "name": "rachaai-brazilian",
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api/$1"
    },
    {
      "src": "/(.*)",
      "dest": "/$1"
    }
  ],
  "functions": {
    "api/ai/chat.ts": {
      "maxDuration": 30
    }
  },
  "env": {
    "BRAZILIAN_REGION": "true",
    "LGPD_COMPLIANCE": "true",
    "CLAUDE_COST_OPTIMIZATION": "true"
  },
  "regions": ["gru1", "sao1"],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        },
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.anthropic.com https://*.supabase.co https://*.redis.com;"
        }
      ]
    }
  ]
}
```

---

## 2. Supabase Database Deployment

### 2.1 Database Migration Script

**File:** `scripts/deploy-database.sh`

```bash
#!/bin/bash

# RachaAI Database Deployment Script
# LGPD-compliant database setup

set -e

echo "üóÑÔ∏è Deploying RachaAI database with LGPD compliance..."

# Validate environment
if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    echo "‚ùå Supabase credentials not set"
    exit 1
fi

# Run migrations
echo "üìä Running database migrations..."

supabase db push \
    --project-ref $SUPABASE_PROJECT_REF \
    --password $SUPABASE_DB_PASSWORD

# Setup LGPD compliance tables
echo "üîí Setting up LGPD compliance tables..."

psql $SUPABASE_URL -c "
-- LGPD Compliance Tables
CREATE TABLE IF NOT EXISTS lgpd_consents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    consent_type VARCHAR(50) NOT NULL,
    consent_given BOOLEAN NOT NULL,
    consent_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS data_processing_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    processing_type VARCHAR(50) NOT NULL,
    data_category VARCHAR(50) NOT NULL,
    processing_purpose TEXT NOT NULL,
    retention_period INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS user_data_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    request_type VARCHAR(50) NOT NULL,
    request_status VARCHAR(20) DEFAULT 'pending',
    request_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    processed_date TIMESTAMP WITH TIME ZONE,
    data_export_url TEXT
);
"

# Setup RLS policies for LGPD
echo "üîê Setting up Row Level Security for LGPD..."

psql $SUPABASE_URL -c "
-- Enable RLS on all tables
ALTER TABLE lgpd_consents ENABLE ROW LEVEL SECURITY;
ALTER TABLE data_processing_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_data_requests ENABLE ROW LEVEL SECURITY;

-- LGPD Consent policies
CREATE POLICY lgpd_consents_user_policy ON lgpd_consents
    FOR ALL USING (auth.uid() = user_id);

-- Data processing logs policies
CREATE POLICY data_processing_logs_user_policy ON data_processing_logs
    FOR ALL USING (auth.uid() = user_id);

-- User data requests policies
CREATE POLICY user_data_requests_user_policy ON user_data_requests
    FOR ALL USING (auth.uid() = user_id);
"

echo "‚úÖ Database deployment completed!"
```

### 2.2 Supabase Configuration

**File:** `supabase/config.toml`

```toml
[api]
enabled = true
port = 54321
schemas = ["public", "storage", "graphql_public"]
extra_search_path = ["public", "extensions"]
max_rows = 1000

[db]
port = 54322
shadow_port = 54320
major_version = 15

[studio]
enabled = true
port = 54323
api_url = "http://localhost:54321"

[inbucket]
enabled = true
port = 54324
smtp_port = 54325
pop3_port = 54326

[storage]
enabled = true
file_size_limit = "50MiB"

[auth]
enabled = true
port = 54327
site_url = "https://rachaai.vercel.app"
additional_redirect_urls = ["https://rachaai.vercel.app"]
jwt_expiry = 3600
refresh_token_rotation_enabled = true
security_update_password_require_reauthentication = true

[edge_runtime]
enabled = true
port = 54328

[analytics]
enabled = false

[functions]
verify_jwt = true
```

---

## 3. Redis Cloud Deployment

### 3.1 Redis Configuration Script

**File:** `scripts/deploy-redis.sh`

```bash
#!/bin/bash

# RachaAI Redis Cloud Deployment Script
# Brazilian-optimized caching setup

set -e

echo "üî¥ Deploying Redis Cloud for Brazilian optimization..."

# Validate Redis credentials
if [ -z "$REDIS_URL" ]; then
    echo "‚ùå REDIS_URL not set"
    exit 1
fi

# Test Redis connection
echo "üîó Testing Redis connection..."

redis-cli -u $REDIS_URL ping

# Setup Brazilian-optimized caching
echo "‚öôÔ∏è Setting up Brazilian caching strategies..."

redis-cli -u $REDIS_URL -c "
-- Session caching (1 hour)
CONFIG SET maxmemory-policy allkeys-lru
CONFIG SET maxmemory 512mb

-- Set Brazilian-specific keys
SET brazilian:regions '[\"SP\", \"RJ\", \"NE\", \"Sul\"]'
SET brazilian:cultural_patterns '[\"rod√≠zio\", \"happy hour\", \"anivers√°rio\", \"churrasco\", \"vaquinha\"]'
SET brazilian:peak_hours '{\"morning\": [7, 9], \"lunch\": [12, 14], \"evening\": [18, 20], \"weekend\": [19, 22]}'

-- Setup cost tracking
SET claude:costs '{\"haiku\": 0.02, \"sonnet\": 0.10, \"opus\": 0.15}'
SET claude:daily_budget 2.00
SET claude:monthly_budget 50.00

-- Setup performance monitoring
SET performance:targets '{\"haiku_response_time\": 1000, \"sonnet_response_time\": 2500, \"opus_response_time\": 5000}'
"

echo "‚úÖ Redis deployment completed!"
```

### 3.2 Redis Configuration

**File:** `redis.conf`

```conf
# RachaAI Redis Configuration
# Brazilian-optimized settings

# Memory management
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Brazilian region optimization
timeout 300
tcp-keepalive 60

# Performance optimization
save 900 1
save 300 10
save 60 10000

# Security
requirepass ${REDIS_PASSWORD}

# Brazilian-specific settings
notify-keyspace-events "Ex"
```

---

## 4. Environment Configuration

### 4.1 Production Environment

**File:** `.env.production`

```bash
# RachaAI Production Environment
# Brazilian-optimized configuration

# Vercel Configuration
VERCEL_TOKEN=${VERCEL_TOKEN}
VERCEL_PROJECT_ID=${VERCEL_PROJECT_ID}

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
SUPABASE_PROJECT_REF=${SUPABASE_PROJECT_REF}

# Redis Configuration
REDIS_URL=${REDIS_URL}
REDIS_PASSWORD=${REDIS_PASSWORD}

# Claude AI Configuration
CLAUDE_API_KEY=${CLAUDE_API_KEY}
CLAUDE_ORGANIZATION_ID=${CLAUDE_ORGANIZATION_ID}

# Brazilian Configuration
NEXT_PUBLIC_BRAZILIAN_REGION=true
NEXT_PUBLIC_LGPD_COMPLIANCE=true
NEXT_PUBLIC_CLAUDE_COST_OPTIMIZATION=true

# Performance Configuration
NEXT_PUBLIC_HAIKU_RESPONSE_TIME=1000
NEXT_PUBLIC_SONNET_RESPONSE_TIME=2500
NEXT_PUBLIC_OPUS_RESPONSE_TIME=5000

# Cost Management
NEXT_PUBLIC_DAILY_BUDGET=2.00
NEXT_PUBLIC_MONTHLY_BUDGET=50.00

# Regional Configuration
NEXT_PUBLIC_SP_OPTIMIZATION=true
NEXT_PUBLIC_RJ_OPTIMIZATION=true
NEXT_PUBLIC_NE_OPTIMIZATION=true
NEXT_PUBLIC_SUL_OPTIMIZATION=true

# LGPD Compliance
NEXT_PUBLIC_DATA_RETENTION_DAYS=90
NEXT_PUBLIC_CONSENT_REQUIRED=true
NEXT_PUBLIC_COOKIE_CONSENT=true

# Monitoring
NEXT_PUBLIC_SENTRY_DSN=${SENTRY_DSN}
NEXT_PUBLIC_ANALYTICS_ID=${ANALYTICS_ID}
```

### 4.2 Staging Environment

**File:** `.env.staging`

```bash
# RachaAI Staging Environment
# Testing configuration

# Same as production but with staging URLs
NEXT_PUBLIC_SUPABASE_URL=${STAGING_SUPABASE_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${STAGING_SUPABASE_ANON_KEY}
REDIS_URL=${STAGING_REDIS_URL}

# Reduced budgets for testing
NEXT_PUBLIC_DAILY_BUDGET=0.50
NEXT_PUBLIC_MONTHLY_BUDGET=10.00

# Testing flags
NEXT_PUBLIC_TESTING_MODE=true
NEXT_PUBLIC_MOCK_CLAUDE=true
```

---

## 5. GitHub Actions Deployment

### 5.1 Main Deployment Workflow

**File:** `.github/workflows/deploy-brazilian.yml`

```yaml
name: Deploy RachaAI Brazilian

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm run test:all
    
    - name: Run accessibility tests
      run: npm run test:accessibility
    
    - name: Run performance tests
      run: npm run test:performance

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build for staging
      run: npm run build:staging
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
        REDIS_URL: ${{ secrets.STAGING_REDIS_URL }}
    
    - name: Deploy to Vercel (Staging)
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--target staging'

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build for production
      run: npm run build:production
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        REDIS_URL: ${{ secrets.REDIS_URL }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
    
    - name: Deploy database
      run: ./scripts/deploy-database.sh
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
    
    - name: Deploy Redis
      run: ./scripts/deploy-redis.sh
      env:
        REDIS_URL: ${{ secrets.REDIS_URL }}
    
    - name: Deploy to Vercel (Production)
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
    
    - name: Run post-deployment tests
      run: npm run test:post-deployment
      env:
        DEPLOYMENT_URL: ${{ steps.deploy.outputs.preview-url }}

  monitor:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Monitor deployment
      run: |
        echo "üîç Monitoring RachaAI deployment..."
        
        # Check Brazilian edge locations
        curl -I https://rachaai.vercel.app
        
        # Check Supabase connection
        curl -I ${{ secrets.SUPABASE_URL }}
        
        # Check Redis connection
        redis-cli -u ${{ secrets.REDIS_URL }} ping
        
        echo "‚úÖ All systems operational!"
```

---

## 6. Monitoring and Alerts

### 6.1 Performance Monitoring

**File:** `scripts/monitor-performance.sh`

```bash
#!/bin/bash

# RachaAI Performance Monitoring Script
# Brazilian-optimized monitoring

set -e

echo "üìä Monitoring RachaAI performance..."

# Check response times
echo "‚è±Ô∏è Checking response times..."

HAIKU_RESPONSE=$(curl -s -w "%{time_total}" -o /dev/null https://rachaai.vercel.app/api/ai/chat)
SONNET_RESPONSE=$(curl -s -w "%{time_total}" -o /dev/null https://rachaai.vercel.app/api/ai/chat)
OPUS_RESPONSE=$(curl -s -w "%{time_total}" -o /dev/null https://rachaai.vercel.app/api/ai/chat)

# Check Brazilian regions
echo "üåç Checking Brazilian regions..."

for region in "SP" "RJ" "NE" "Sul"; do
    RESPONSE_TIME=$(curl -s -w "%{time_total}" -o /dev/null \
        -H "X-Brazilian-Region: $region" \
        https://rachaai.vercel.app/api/ai/chat)
    
    echo "Region $region: ${RESPONSE_TIME}s"
done

# Check Claude costs
echo "üí∞ Checking Claude costs..."

DAILY_COST=$(redis-cli -u $REDIS_URL GET claude:daily_cost)
MONTHLY_COST=$(redis-cli -u $REDIS_URL GET claude:monthly_cost)

echo "Daily cost: R$ $DAILY_COST"
echo "Monthly cost: R$ $MONTHLY_COST"

# Alert if over budget
if (( $(echo "$DAILY_COST > 1.60" | bc -l) )); then
    echo "‚ö†Ô∏è Daily budget warning: R$ $DAILY_COST"
    # Send alert
fi

echo "‚úÖ Performance monitoring completed!"
```

### 6.2 Health Check Script

**File:** `scripts/health-check.sh`

```bash
#!/bin/bash

# RachaAI Health Check Script
# Comprehensive system health monitoring

set -e

echo "üè• Running RachaAI health check..."

# Check Vercel deployment
echo "üåê Checking Vercel deployment..."
VERCEL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://rachaai.vercel.app)

if [ "$VERCEL_STATUS" != "200" ]; then
    echo "‚ùå Vercel deployment issue: HTTP $VERCEL_STATUS"
    exit 1
fi

# Check Supabase connection
echo "üóÑÔ∏è Checking Supabase connection..."
SUPABASE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SUPABASE_URL)

if [ "$SUPABASE_STATUS" != "200" ]; then
    echo "‚ùå Supabase connection issue: HTTP $SUPABASE_STATUS"
    exit 1
fi

# Check Redis connection
echo "üî¥ Checking Redis connection..."
REDIS_PING=$(redis-cli -u $REDIS_URL ping)

if [ "$REDIS_PING" != "PONG" ]; then
    echo "‚ùå Redis connection issue"
    exit 1
fi

# Check Claude API
echo "ü§ñ Checking Claude API..."
CLAUDE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    -H "Authorization: Bearer $CLAUDE_API_KEY" \
    -H "Content-Type: application/json" \
    -d '{"model":"claude-3-haiku-20240307","max_tokens":10,"messages":[{"role":"user","content":"test"}]}' \
    https://api.anthropic.com/v1/messages)

if [ "$CLAUDE_STATUS" != "200" ]; then
    echo "‚ùå Claude API issue: HTTP $CLAUDE_STATUS"
    exit 1
fi

echo "‚úÖ All systems healthy!"
```

---

## 7. Rollback and Recovery

### 7.1 Rollback Script

**File:** `scripts/rollback.sh`

```bash
#!/bin/bash

# RachaAI Rollback Script
# Emergency rollback to previous deployment

set -e

echo "üîÑ Starting emergency rollback..."

# Get current deployment
CURRENT_DEPLOYMENT=$(vercel ls --token $VERCEL_TOKEN | grep rachaai | head -1 | awk '{print $1}')

# Get previous deployment
PREVIOUS_DEPLOYMENT=$(vercel ls --token $VERCEL_TOKEN | grep rachaai | head -2 | tail -1 | awk '{print $1}')

echo "Current deployment: $CURRENT_DEPLOYMENT"
echo "Rolling back to: $PREVIOUS_DEPLOYMENT"

# Rollback to previous deployment
vercel rollback $PREVIOUS_DEPLOYMENT --token $VERCEL_TOKEN --confirm

echo "‚úÖ Rollback completed successfully!"

# Notify team
curl -X POST $SLACK_WEBHOOK_URL \
    -H "Content-Type: application/json" \
    -d "{\"text\":\"üö® RachaAI emergency rollback completed. Previous deployment restored.\"}"
```

---

## 8. Success Criteria

### **Deployment Success Metrics:**
- **Vercel Deployment:** <5 minutes
- **Database Migration:** <2 minutes
- **Redis Setup:** <1 minute
- **Health Check:** All systems operational
- **Performance:** <2s response time for Brazilian users
- **Cost Management:** <R$ 2.00 daily budget maintained

### **Monitoring Requirements:**
- **Real-time performance monitoring**
- **Brazilian regional optimization**
- **Claude AI cost tracking**
- **LGPD compliance validation**
- **Automated rollback on failures**

The deployment automation scripts ensure RachaAI is **optimally deployed** for Brazilian users with **LGPD compliance**, **regional performance optimization**, and **cost-effective operation**. 